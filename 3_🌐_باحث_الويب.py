import streamlit as st
import os
from dotenv import load_dotenv
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_community.tools import DuckDuckGoSearchRun

# ---------------------------------------------------------
# 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุงูุงุชุตุงู ุจุงูู AI
# ---------------------------------------------------------
st.set_page_config(page_title="ุจุงุญุซ ุงูููุจ ุงูููุชูุญ", page_icon="๐")

load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")

if not api_key:
    st.error("โ ุนุฐุฑุงูุ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู.")
    st.stop()

# ---------------------------------------------------------
# 2. ุฅุนุฏุงุฏ ุฃุฏุงุฉ ุงูุจุญุซ ูู ุงูููุจ
# ---------------------------------------------------------
search_tool = DuckDuckGoSearchRun()

# ---------------------------------------------------------
# 3. ูุงุฌูุฉ ุงููุณุชุฎุฏู (ุจุงุญุซ ุงูููุจ)
# ---------------------------------------------------------
st.title("๐ ุจุงุญุซ ุงูููุจ ุงูุฃูุงุฏููู")
st.caption("ูุฐู ุงูุฃุฏุงุฉ ุชุจุญุซ ูู ุงูุฅูุชุฑูุช ุงููุจุงุดุฑ ูุฌูุจ ุฃุญุฏุซ ุงููุตุงุฏุฑ ุงูุฎุงุฑุฌูุฉ.")

st.subheader("ุฃุฏุฎู ููุถูุน ุงูุจุญุซ ุงูุฐู ูุชุทูุจ ูุตุงุฏุฑ ุฎุงุฑุฌูุฉ:")
topic = st.text_input("ูุซุงู: 'ุฃุญุฏุซ ุงูุชุนุฏููุงุช ุงููุถุงุฆูุฉ ูู 2025' ุฃู 'ููุงุฑูุฉ ุจูู 5 ููุงูุงุช ุนู...'")

if "web_research" not in st.session_state:
    st.session_state.web_research = ""

if st.button("๐ ุงุจุฏุฃ ุงูุจุญุซ ูุงูุชุญููู", type="primary"):
    if not topic:
        st.warning("ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุถูุน ุงูุจุญุซ ุฃููุงู.")
    else:
        with st.spinner(f"ุฌุงุฑู ุงูุจุญุซ ูู ุงูุฅูุชุฑูุช ุนู '{topic}'..."):
            try:
                st.write(f"๐ ูุชู ุงูุขู ุงูุจุญุซ ุนู ุงููุตุงุฏุฑ ุงูุฎุงุฑุฌูุฉ...")
                search_results = search_tool.run(topic)
                
                llm = ChatGoogleGenerativeAI(
                    model="gemini-1.5-pro",
                    google_api_key=api_key,
                    temperature=0.4
                )
                
                prompt = f"""
                ุฃูุช ุจุงุญุซ ุฃูุงุฏููู ูุชุฎุตุตุ ููููุชู ูู ูุชุงุจุฉ ูุฑูุฉ ุจุญุซูุฉ (Review Paper).
                
                [ููุถูุน ุงูุจุญุซ ุงููุทููุจ]:
                {topic}
                
                [ุงููุตุงุฏุฑ ุงูุชู ูุฌุฏุชูุง ุนูู ุงูุฅูุชุฑูุช (Snippets)]:
                {search_results}
                
                ุชุนูููุงุช ุตุงุฑูุฉ:
                1. ูู ุจูุชุงุจุฉ ุชูุฑูุฑ ุจุญุซู ููุตู ููุชูุงุณู ุญูู ุงูููุถูุน ุงููุทููุจ.
                2. ูุฌุจ ุฃู ุชุณุชุฎุฏู "ุญุตุฑูุงู" ุงููุนูููุงุช ุงูููุฌูุฏุฉ ูู [ุงููุตุงุฏุฑ ุงูุชู ูุฌุฏุชูุง ุนูู ุงูุฅูุชุฑูุช].
                3. ูู ุจุฅุนุงุฏุฉ ุตูุงุบุฉ ุงููุนูููุงุช ุจุงููุงููุ ูุง ุชูุณุฎ ุญุฑููุงู.
                4. ูู ุจุชูุธูู ุงูุจุญุซ ูู (ููุฏูุฉุ ููุงุท ุฑุฆูุณูุฉุ ุฎุงุชูุฉ).
                5. [ูุงู ุฌุฏุงู]: ุงุฐูุฑ ุงููุตุงุฏุฑ (URLs) ุงูุชู ุงุณุชูุฏุช ุฅูููุง (ุฅุฐุง ุธูุฑุช ูู ุงููุนูููุงุช) ูู ููุงูุฉ ุงูุจุญุซ.
                """
                
                st.write(f"๐ง ูุชู ุงูุขู ุตูุงุบุฉ ุงูุจุญุซ...")
                response = llm.invoke(prompt)
                
                st.session_state.web_research = response.content
                
                st.markdown("### ๐ ูุณูุฏุฉ ุงูุจุญุซ (ูุน ุงููุตุงุฏุฑ ุงูุฎุงุฑุฌูุฉ):")
                st.success("ุชู ุฅูุดุงุก ุงูุจุญุซ ุจูุฌุงุญ!")
                st.markdown(st.session_state.web_research)
                
                with st.expander("ุงูุธุฑ ุงููุตุงุฏุฑ ุงูุฃูููุฉ ุงูุชู ุชู ุงูุนุซูุฑ ุนูููุง"):
                    st.caption(search_results)
                        
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ: {e}")

# 4. ุฒุฑ ุงูุชุญููู
if st.session_state.web_research:
    st.divider()
    st.subheader("ุชุญููู ุงูุจุญุซ")
    st.download_button(
        label="๐ฅ ุชุญููู ุงูุจุญุซ ูููู (.txt)",
        data=st.session_state.web_research,
        file_name="WebResearch.txt",
        mime="text/plain"
    )

# --- ุงูุชุฐููู ุงููุญุฏุซ ---
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; color: #808080; font-size: 14px;'>
    ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฎุฏูุฉ ุงูุจุญุซ ุงูุนููู ๐ | 2025
    </div>
    """, 
    unsafe_allow_html=True
)